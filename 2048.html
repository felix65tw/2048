<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2048 - éŸ¿æ‡‰å¼éŸ³æ•ˆç‰ˆ</title>
    <style>
        :root {
            --board-size-desktop: 500px;
            --board-size-mobile: 300px; /* æ‰‹æ©Ÿç‰ˆå°ºå¯¸ */
            --grid-gap: 15px;
            --tile-base-color: #cdc1b4;
            --bg-color: #faf8ef;
            --board-bg: #bbada0;
        }

        body {
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: #776e65;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´å¹²æ“¾éŠæˆ² */
            overscroll-behavior: none; 
            touch-action: none; 
        }

        h1 {
            font-size: 60px;
            margin: 0;
            line-height: 1.2;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: var(--board-size-desktop);
            margin-bottom: 10px;
        }

        .score-container {
            background-color: #bbada0;
            padding: 10px 25px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            display: flex;
            flex-direction: column;
        }

        .score-label {
            font-size: 13px;
            color: #eee4da;
        }

        #score {
            font-size: 25px;
        }

        .new-game-btn {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 18px;
            outline: none;
        }

        .new-game-btn:active {
            transform: scale(0.96);
        }

        /* éŠæˆ²æ£‹ç›¤ */
        #board {
            width: var(--board-size-desktop);
            height: var(--board-size-desktop);
            background-color: var(--board-bg);
            border-radius: 6px;
            position: relative;
            padding: var(--grid-gap);
            box-sizing: border-box;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: var(--grid-gap);
        }

        .tile {
            width: 100%;
            height: 100%;
            background-color: var(--tile-base-color);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 55px;
            font-weight: bold;
            color: #776e65;
            transition: transform 0.1s ease-in-out; 
            /* å‹•ç•«æ•ˆæœ */
            animation: pop 0.2s ease-in;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* æ•¸å­—é¡è‰²èˆ‡å­—é«”å¤§å°èª¿æ•´ */
        .x2 { background-color: #eee4da; }
        .x4 { background-color: #ede0c8; }
        .x8 { background-color: #f2b179; color: #f9f6f2; }
        .x16 { background-color: #f59563; color: #f9f6f2; }
        .x32 { background-color: #f67c5f; color: #f9f6f2; }
        .x64 { background-color: #f65e3b; color: #f9f6f2; }
        .x128 { background-color: #edcf72; color: #f9f6f2; font-size: 45px; box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.23815), inset 0 0 0 1px rgba(255, 255, 255, 0.14286); }
        .x256 { background-color: #edcc61; color: #f9f6f2; font-size: 45px; box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.31746), inset 0 0 0 1px rgba(255, 255, 255, 0.19048); }
        .x512 { background-color: #edc850; color: #f9f6f2; font-size: 45px; }
        .x1024 { background-color: #edc53f; color: #f9f6f2; font-size: 35px; }
        .x2048 { background-color: #edc22e; color: #f9f6f2; font-size: 35px; box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.55556), inset 0 0 0 1px rgba(255, 255, 255, 0.33333); }

        #game-over {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(238, 228, 218, 0.73);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: bold;
            color: #776e65;
            border-radius: 6px;
        }

        .instructions {
            margin-top: 20px;
            font-size: 16px;
            color: #776e65;
        }

        /* --- æ‰‹æ©Ÿç‰ˆ RWD è¨­å®š --- */
        @media screen and (max-width: 520px) {
            .header-container {
                width: var(--board-size-mobile);
            }

            #board {
                width: var(--board-size-mobile);
                height: var(--board-size-mobile);
                padding: 10px;
                gap: 10px;
            }

            .tile {
                font-size: 30px; /* æ‰‹æ©Ÿä¸Šå­—é«”æ”¹å° */
            }

            .x128, .x256, .x512 { font-size: 25px; }
            .x1024, .x2048 { font-size: 20px; }

            h1 { font-size: 40px; }
        }
        
        .sound-toggle {
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>2048</h1>
        <div class="score-container">
            <span class="score-label">SCORE</span>
            <span id="score">0</span>
        </div>
        <button class="new-game-btn" onclick="initGame()">æ–°éŠæˆ²</button>
    </div>

    <div id="board">
        <div id="game-over">
            <p>éŠæˆ²çµæŸ!</p>
            <button class="new-game-btn" onclick="initGame()">å†è©¦ä¸€æ¬¡</button>
        </div>
        <!-- æ ¼å­ç”± JS ç”Ÿæˆ -->
    </div>

    <p class="instructions" id="instructions-text">ä½¿ç”¨ <strong>æ–¹å‘éµ</strong> æˆ– <strong>æ»‘å‹•</strong> ä¾†ç§»å‹•</p>
    <div class="sound-toggle" onclick="toggleSound()">ğŸ”Š éŸ³æ•ˆ: é–‹å•Ÿ</div>

    <script>
        // --- 1. éŠæˆ²åƒæ•¸èˆ‡è®Šæ•¸ ---
        const rows = 4;
        const columns = 4;
        let board;
        let score = 0;
        let isGameOver = false;
        let soundEnabled = true;

        // --- 2. éŸ³æ•ˆç³»çµ± (Web Audio API) ---
        // é€™è®“æˆ‘å€‘ä¸éœ€è¦å¤–éƒ¨ mp3 æª”æ¡ˆå°±èƒ½ç”¢ç”Ÿå¯æ„›çš„è²éŸ³
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') {
                // ç€è¦½å™¨æ”¿ç­–è¦æ±‚ä½¿ç”¨è€…äº’å‹•å¾Œæ‰èƒ½æ’­æ”¾è²éŸ³
                audioCtx.resume();
                if (!soundEnabled) return;
            }

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'move') {
                // çŸ­ä¿ƒçš„æ³¢æ³¢è²
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);

            } else if (type === 'merge') {
                // å¯æ„›çš„å®å®è²
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);

            } else if (type === 'gameover') {
                // å¤±æ•—çš„è²éŸ³
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.5);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').innerText = soundEnabled ? "ğŸ”Š éŸ³æ•ˆ: é–‹å•Ÿ" : "ğŸ”‡ éŸ³æ•ˆ: é—œé–‰";
        }

        // --- 3. éŠæˆ²åˆå§‹åŒ– ---
        window.onload = function() {
            initGame();
        }

        function initGame() {
            board = [
                [0, 0, 0, 0],
                [0, 0, 0, 0],
                [0, 0, 0, 0],
                [0, 0, 0, 0]
            ];
            score = 0;
            isGameOver = false;
            document.getElementById("score").innerText = score;
            document.getElementById("game-over").style.display = "none";
            
            // æ¸…ç©ºèˆŠæ ¼å­
            const boardEl = document.getElementById("board");
            const tiles = document.querySelectorAll(".tile");
            tiles.forEach(t => t.remove());

            // å‰µå»ºç¶²æ ¼
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    let tile = document.createElement("div");
                    tile.id = `${r}-${c}`;
                    tile.classList.add("tile");
                    let num = board[r][c];
                    updateTile(tile, num);
                    boardEl.appendChild(tile);
                }
            }

            setTwo();
            setTwo();
        }

        function updateTile(tile, num) {
            tile.innerText = "";
            tile.className = "tile"; // é‡ç½® class
            if (num > 0) {
                tile.innerText = num;
                if (num <= 2048) {
                    tile.classList.add("x" + num);
                } else {
                    tile.classList.add("x2048");
                }
            }
        }

        // --- 4. ç§»å‹•é‚è¼¯ (æ ¸å¿ƒ) ---
        function filterZero(row) {
            return row.filter(num => num != 0);
        }

        function slide(row) {
            // [0, 2, 2, 2] -> [2, 2, 2]
            row = filterZero(row);
            let mergedThisRow = false;

            for (let i = 0; i < row.length - 1; i++) {
                if (row[i] == row[i+1]) {
                    row[i] *= 2;
                    row[i+1] = 0;
                    score += row[i];
                    mergedThisRow = true;
                }
            }
            
            row = filterZero(row);
            while (row.length < columns) {
                row.push(0);
            }
            return { newRow: row, merged: mergedThisRow };
        }

        function move(direction) {
            if (isGameOver) return;
            let moved = false;
            let mergedInMove = false;

            if (direction === 'Left' || direction === 'Right') {
                for (let r = 0; r < rows; r++) {
                    let row = board[r];
                    let original = JSON.stringify(row);
                    
                    if (direction === 'Right') row.reverse();
                    let result = slide(row);
                    row = result.newRow;
                    if (result.merged) mergedInMove = true;
                    if (direction === 'Right') row.reverse();

                    board[r] = row;
                    if (JSON.stringify(board[r]) !== original) moved = true;

                    // Update DOM
                    for (let c = 0; c < columns; c++) {
                        let tile = document.getElementById(`${r}-${c}`);
                        updateTile(tile, board[r][c]);
                    }
                }
            } 
            else if (direction === 'Up' || direction === 'Down') {
                for (let c = 0; c < columns; c++) {
                    let row = [board[0][c], board[1][c], board[2][c], board[3][c]];
                    let original = JSON.stringify(row);

                    if (direction === 'Down') row.reverse();
                    let result = slide(row);
                    row = result.newRow;
                    if (result.merged) mergedInMove = true;
                    if (direction === 'Down') row.reverse();

                    // Update Board & DOM
                    for (let r = 0; r < rows; r++) {
                        board[r][c] = row[r];
                        let tile = document.getElementById(`${r}-${c}`);
                        updateTile(tile, board[r][c]);
                    }
                    if (JSON.stringify(row) !== original) moved = true;
                }
            }

            if (moved) {
                document.getElementById("score").innerText = score;
                setTwo();
                
                // æ’­æ”¾éŸ³æ•ˆ
                if (mergedInMove) playSound('merge');
                else playSound('move');

                checkGameOver();
            }
        }

        // --- 5. ç”Ÿæˆæ•¸å­— ---
        function setTwo() {
            if (!hasEmptyTile()) return;
            let found = false;
            while (!found) {
                let r = Math.floor(Math.random() * rows);
                let c = Math.floor(Math.random() * columns);
                if (board[r][c] == 0) {
                    board[r][c] = Math.random() > 0.1 ? 2 : 4;
                    let tile = document.getElementById(`${r}-${c}`);
                    updateTile(tile, board[r][c]);
                    found = true;
                }
            }
        }

        function hasEmptyTile() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (board[r][c] == 0) return true;
                }
            }
            return false;
        }

        function checkGameOver() {
            if (hasEmptyTile()) return;
            // æª¢æŸ¥æ˜¯å¦å¯åˆä½µ
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (c < columns - 1 && board[r][c] == board[r][c+1]) return;
                    if (r < rows - 1 && board[r][c] == board[r+1][c]) return;
                }
            }
            
            isGameOver = true;
            document.getElementById("game-over").style.display = "flex";
            playSound('gameover');
        }

        // --- 6. è¼¸å…¥æ§åˆ¶ (éµç›¤ & è§¸æ§) ---
        
        // éµç›¤
        document.addEventListener('keyup', (e) => {
            if (e.code == "ArrowLeft") move('Left');
            else if (e.code == "ArrowRight") move('Right');
            else if (e.code == "ArrowUp") move('Up');
            else if (e.code == "ArrowDown") move('Down');
        });

        // è§¸æ§ (æ‰‹æ©Ÿç‰ˆ)
        let startX, startY;
        const boardDom = document.getElementById('board');

        document.addEventListener('touchstart', (e) => {
            if(e.touches.length > 1) return; // å¿½ç•¥å¤šé»è§¸æ§
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            // å˜—è©¦è§£é–éŸ³æ•ˆ Context (å› ç‚ºç€è¦½å™¨éœ€è¦äº’å‹•æ‰èƒ½æ’­éŸ³)
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            e.preventDefault(); // é˜²æ­¢æ»‘å‹•æ™‚æ²å‹•ç•«é¢
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if(!startX || !startY) return;

            let endX = e.changedTouches[0].clientX;
            let endY = e.changedTouches[0].clientY;

            let diffX = endX - startX;
            let diffY = endY - startY;

            // åˆ¤æ–·æ˜¯æ°´å¹³é‚„æ˜¯å‚ç›´æ»‘å‹•
            if (Math.abs(diffX) > Math.abs(diffY)) {
                // æ°´å¹³
                if (Math.abs(diffX) > 30) { // é–€æª»å€¼ï¼Œé˜²æ­¢èª¤è§¸
                    if (diffX > 0) move('Right');
                    else move('Left');
                }
            } else {
                // å‚ç›´
                if (Math.abs(diffY) > 30) {
                    if (diffY > 0) move('Down');
                    else move('Up');
                }
            }
            startX = null;
            startY = null;
        });

    </script>
</body>
</html>