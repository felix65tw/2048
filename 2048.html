<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2048 - ç©¶æ¥µåŠ å¼·ç‰ˆ</title>
    <style>
        :root {
            --board-size-desktop: 500px;
            --board-size-mobile: 320px;
            --grid-gap: 10px;
            --tile-base-color: #cdc1b4;
            --bg-color: #faf8ef;
            --board-bg: #bbada0;
        }

        body {
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: #776e65;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overscroll-behavior: none; 
            touch-action: none; 
        }

        h1 {
            font-size: 50px;
            margin: 5px 0;
            line-height: 1;
        }

        /* æ§åˆ¶åˆ—ä½ˆå±€ */
        .controls-container {
            width: var(--board-size-desktop);
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .score-box {
            background-color: #bbada0;
            padding: 5px 15px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            min-width: 80px;
        }
        .score-label { font-size: 12px; color: #eee4da; }
        #score { font-size: 20px; }

        /* æŒ‰éˆ•èˆ‡é¸å–®æ¨£å¼ */
        .btn {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            outline: none;
            transition: background 0.2s;
        }
        .btn:hover { background-color: #7f6a56; }
        .btn:active { transform: scale(0.96); }

        .btn-undo {
            background-color: #e78e46; /* æ©˜è‰²å€åˆ† */
        }
        .btn-undo:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        select {
            padding: 8px;
            border-radius: 5px;
            border: 2px solid #8f7a66;
            background: #faf8ef;
            color: #776e65;
            font-weight: bold;
            font-size: 16px;
        }

        /* éŠæˆ²æ£‹ç›¤ */
        #board {
            width: var(--board-size-desktop);
            height: var(--board-size-desktop);
            background-color: var(--board-bg);
            border-radius: 6px;
            position: relative;
            padding: var(--grid-gap);
            box-sizing: border-box;
            display: grid;
            /* grid-template-columns/rows ç”± JS å‹•æ…‹è¨­å®š */
            gap: var(--grid-gap);
        }

        .tile {
            width: 100%;
            height: 100%;
            background-color: var(--tile-base-color);
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #776e65;
            animation: pop 0.2s ease-in;
            user-select: none;
        }

        /* å‹•æ…‹å­—é«”å¤§å°èª¿æ•´ (æ ¹æ“šæ£‹ç›¤æ ¼æ•¸) */
        /* é è¨­ 4x4 */
        .size-3 .tile { font-size: 60px; }
        .size-4 .tile { font-size: 50px; }
        .size-5 .tile { font-size: 40px; }
        .size-6 .tile { font-size: 30px; }
        .size-8 .tile { font-size: 22px; }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* é¡è‰²é…ç½® */
        .x2 { background-color: #eee4da; }
        .x4 { background-color: #ede0c8; }
        .x8 { background-color: #f2b179; color: #f9f6f2; }
        .x16 { background-color: #f59563; color: #f9f6f2; }
        .x32 { background-color: #f67c5f; color: #f9f6f2; }
        .x64 { background-color: #f65e3b; color: #f9f6f2; }
        .x128 { background-color: #edcf72; color: #f9f6f2; box-shadow: 0 0 30px 5px rgba(243, 215, 116, 0.4); } 
        .x256 { background-color: #edcc61; color: #f9f6f2; box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.5); }
        .x512 { background-color: #edc850; color: #f9f6f2; }
        .x1024 { background-color: #edc53f; color: #f9f6f2; }
        .x2048 { background-color: #edc22e; color: #f9f6f2; }

        /* é‡å°é«˜ä½æ•¸çš„å­—é«”å¾®èª¿ */
        .size-4 .tile.x128, .size-4 .tile.x256, .size-4 .tile.x512 { font-size: 40px; }
        .size-4 .tile.x1024, .size-4 .tile.x2048 { font-size: 30px; }
        
        /* å¯†é›†ææ‡¼ç—‡æ¨¡å¼(8x8)å­—é«”å¾®èª¿ */
        .size-8 .tile.x128, .size-8 .tile.x256, .size-8 .tile.x512 { font-size: 18px; }
        .size-8 .tile.x1024, .size-8 .tile.x2048 { font-size: 14px; }

        #game-over {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(238, 228, 218, 0.73);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: bold;
            border-radius: 6px;
        }

        .instructions { font-size: 14px; margin-top: 15px; color: #776e65;}
        .sound-toggle { margin-top: 10px; cursor: pointer; font-size: 13px; text-decoration: underline; color: #8f7a66;}

        /* --- æ‰‹æ©Ÿç‰ˆ RWD --- */
        @media screen and (max-width: 520px) {
            .controls-container { width: var(--board-size-mobile); }
            #board {
                width: var(--board-size-mobile);
                height: var(--board-size-mobile);
                padding: 5px;
                gap: 5px;
            }
            :root { --grid-gap: 5px; }

            /* æ‰‹æ©Ÿç‰ˆå­—é«”å†ç¸®å°ä¸€é» */
            .size-4 .tile { font-size: 35px; }
            .size-6 .tile { font-size: 20px; }
            .size-8 .tile { font-size: 14px; }
            
            h1 { font-size: 36px; }
        }
    </style>
</head>
<body>

    <div class="controls-container">
        <div class="top-row">
            <h1>2048</h1>
            <div class="score-box">
                <span class="score-label">SCORE</span>
                <span id="score">0</span>
            </div>
        </div>
        
        <div class="bottom-row">
            <!-- å°ºå¯¸é¸æ“‡ -->
            <select id="grid-size">
                <option value="3">3 x 3 (ç°¡å–®)</option>
                <option value="4" selected>4 x 4 (ç¶“å…¸)</option>
                <option value="5">5 x 5 (ä¸­ç­‰)</option>
                <option value="6">6 x 6 (å›°é›£)</option>
                <option value="8">8 x 8 (å°ˆå®¶)</option>
            </select>
            
            <!-- æ–°éŠæˆ² -->
            <button class="btn" onclick="initGame()">æ–°éŠæˆ²</button>
            
            <!-- æ’¤éŠ·æŒ‰éˆ• -->
            <button class="btn btn-undo" id="undo-btn" onclick="undo()" disabled>â†© æ’¤éŠ·</button>
        </div>
    </div>

    <div id="board">
        <div id="game-over">
            <p>éŠæˆ²çµæŸ!</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-undo" onclick="undo()">â†© æ‚”æ£‹</button>
                <button class="btn" onclick="initGame()">é‡ç©</button>
            </div>
        </div>
        <!-- æ ¼å­ç”± JS ç”Ÿæˆ -->
    </div>

    <p class="instructions">æ–¹å‘éµ / æ»‘å‹•ç§»å‹•æ–¹å¡Šï¼Œç›¸åŒæ•¸å­—æœƒåˆä½µ</p>
    <div class="sound-toggle" onclick="toggleSound()">ğŸ”Š éŸ³æ•ˆ: é–‹å•Ÿ</div>

    <script>
        // --- è®Šæ•¸èˆ‡è¨­å®š ---
        let board;
        let score = 0;
        let rows = 4;
        let columns = 4;
        let isGameOver = false;
        let soundEnabled = true;
        
        // æ­·å²ç´€éŒ„å †ç–Š (ç”¨æ–¼æ’¤éŠ·)
        let gameHistory = []; 

        // --- éŸ³æ•ˆç³»çµ± (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') {
                audioCtx.resume();
                if (!soundEnabled) return;
            }

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'move') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(200, now + 0.08);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'merge') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } else if (type === 'gameover') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.8);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.8);
                osc.start(now);
                osc.stop(now + 0.8);
            } else if (type === 'undo') {
                // å€’å¸¶çš„è²éŸ³ (é »ç‡ä¸Šå‡çš„å’»è²)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').innerText = soundEnabled ? "ğŸ”Š éŸ³æ•ˆ: é–‹å•Ÿ" : "ğŸ”‡ éŸ³æ•ˆ: é—œé–‰";
        }

        // --- éŠæˆ²é‚è¼¯ ---

        window.onload = function() {
            initGame();
        }

        function initGame() {
            // è®€å–é¸æ“‡çš„å°ºå¯¸
            const sizeSelect = document.getElementById("grid-size");
            const size = parseInt(sizeSelect.value);
            rows = size;
            columns = size;

            // é‡ç½®è®Šæ•¸
            board = Array.from({ length: rows }, () => Array(columns).fill(0));
            score = 0;
            isGameOver = false;
            gameHistory = []; // æ¸…ç©ºæ­·å²
            updateUndoButton();

            // æ›´æ–° UI
            document.getElementById("score").innerText = score;
            document.getElementById("game-over").style.display = "none";
            
            // è¨­å®š CSS Grid ä½ˆå±€
            const boardEl = document.getElementById("board");
            boardEl.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            boardEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            // è¨­å®š Class ä»¥èª¿æ•´å­—é«”å¤§å° (ä¾‹å¦‚ .size-8)
            boardEl.className = `size-${size}`;

            renderBoard();
            setTwo();
            setTwo();
        }

        // å„²å­˜ç‹€æ…‹ (Deep Copy)
        function saveState() {
            // å°‡ç•¶å‰çš„ board å’Œ score å­˜å…¥æ­·å²
            const state = {
                board: JSON.parse(JSON.stringify(board)),
                score: score
            };
            gameHistory.push(state);
            updateUndoButton();
        }

        // æ’¤éŠ·åŠŸèƒ½
        function undo() {
            if (gameHistory.length === 0) return;

            const lastState = gameHistory.pop();
            board = lastState.board;
            score = lastState.score;
            isGameOver = false; // æ’¤éŠ·å¾Œç•¶ç„¶ä¸ç®—è¼¸
            
            document.getElementById("score").innerText = score;
            document.getElementById("game-over").style.display = "none";
            
            renderBoard();
            updateUndoButton();
            playSound('undo');
        }

        function updateUndoButton() {
            const btn = document.getElementById("undo-btn");
            btn.disabled = gameHistory.length === 0;
        }

        function renderBoard() {
            const boardEl = document.getElementById("board");
            // ä¿ç•™ game-over é®ç½©ï¼Œæ¸…é™¤å…¶ä»–æ–¹å¡Š
            const tiles = document.querySelectorAll(".tile");
            tiles.forEach(t => t.remove());

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    let tile = document.createElement("div");
                    tile.classList.add("tile");
                    let num = board[r][c];
                    
                    if (num > 0) {
                        tile.innerText = num;
                        if (num <= 2048) {
                            tile.classList.add("x" + num);
                        } else {
                            tile.classList.add("x2048");
                        }
                    }
                    boardEl.appendChild(tile);
                }
            }
        }

        function filterZero(row) {
            return row.filter(num => num != 0);
        }

        function slide(row) {
            row = filterZero(row);
            let mergedThisRow = false;

            for (let i = 0; i < row.length - 1; i++) {
                if (row[i] == row[i+1]) {
                    row[i] *= 2;
                    row[i+1] = 0;
                    score += row[i];
                    mergedThisRow = true;
                }
            }
            
            row = filterZero(row);
            while (row.length < columns) {
                row.push(0);
            }
            return { newRow: row, merged: mergedThisRow };
        }

        function move(direction) {
            if (isGameOver) return;

            // åœ¨ç§»å‹•å‰ï¼Œå…ˆå˜—è©¦è¨ˆç®—ç§»å‹•å¾Œçš„çµæœ
            // å¦‚æœçµæœè·Ÿç¾åœ¨ä¸ä¸€æ¨£ï¼Œæ‰çœŸçš„åŸ·è¡Œä¸¦å­˜æª”
            
            // ç‚ºäº†ä¸é‡è¤‡å¯«é‚è¼¯ï¼Œæˆ‘å€‘å…ˆåšä¸€å€‹ Deep Copy ä¾†æ¨¡æ“¬
            let tempBoard = JSON.parse(JSON.stringify(board));
            let tempScore = score;
            let moved = false;
            let mergedInMove = false;

            // åŸ·è¡Œç§»å‹•é‚è¼¯æ–¼ tempBoard
            // é€™è£¡é‚è¼¯ç¨å¾®è¤‡é›œï¼Œç‚ºäº†å¾©ç”¨ä»£ç¢¼ï¼Œæˆ‘ç›´æ¥æ“ä½œçœŸå¯¦ board
            // ä½†åœ¨æ“ä½œå‰å…ˆå­˜æª” (Save State)ï¼Œå¦‚æœæœ€å¾Œç™¼ç¾æ²’ç§»å‹•ï¼Œå†æŠŠæ­·å²ç´€éŒ„ pop å‡ºä¾†å³å¯ (æˆ–è€…åªåœ¨ moved ç‚ºçœŸæ™‚ push)
            
            // æ›´å¥½çš„åšæ³•ï¼šå…ˆä¸å­˜ï¼Œç¢ºå®š moved ç‚ºçœŸï¼Œå†å­˜ "ç§»å‹•å‰" çš„ç‹€æ…‹
            const currentBoardState = JSON.parse(JSON.stringify(board));
            const currentScoreState = score;

            if (direction === 'Left' || direction === 'Right') {
                for (let r = 0; r < rows; r++) {
                    let row = board[r];
                    let original = JSON.stringify(row);
                    
                    if (direction === 'Right') row.reverse();
                    let result = slide(row);
                    row = result.newRow;
                    if (result.merged) mergedInMove = true;
                    if (direction === 'Right') row.reverse();

                    board[r] = row;
                    if (JSON.stringify(board[r]) !== original) moved = true;
                }
            } 
            else if (direction === 'Up' || direction === 'Down') {
                for (let c = 0; c < columns; c++) {
                    let row = [];
                    for(let r=0; r<rows; r++) row.push(board[r][c]);
                    
                    let original = JSON.stringify(row);

                    if (direction === 'Down') row.reverse();
                    let result = slide(row);
                    row = result.newRow;
                    if (result.merged) mergedInMove = true;
                    if (direction === 'Down') row.reverse();

                    for (let r = 0; r < rows; r++) {
                        board[r][c] = row[r];
                    }
                    if (JSON.stringify(row) !== original) moved = true;
                }
            }

            if (moved) {
                // æœ‰ç§»å‹•ç™¼ç”Ÿï¼Œæ‰€ä»¥è¦æŠŠ"ç§»å‹•å‰"çš„ç‹€æ…‹å­˜å…¥æ­·å²
                gameHistory.push({
                    board: currentBoardState,
                    score: currentScoreState
                });
                updateUndoButton();

                document.getElementById("score").innerText = score;
                renderBoard(); // é‡ç¹ªæ•´å€‹ç‰ˆé¢ç¢ºä¿åŒæ­¥
                setTwo();
                
                if (mergedInMove) playSound('merge');
                else playSound('move');

                checkGameOver();
            }
        }

        function setTwo() {
            if (!hasEmptyTile()) return;
            let found = false;
            while (!found) {
                let r = Math.floor(Math.random() * rows);
                let c = Math.floor(Math.random() * columns);
                if (board[r][c] == 0) {
                    board[r][c] = Math.random() > 0.1 ? 2 : 4;
                    // å–®ç¨æ›´æ–° DOM å¢åŠ å‹•ç•«
                    // é€™è£¡ç‚ºäº†ç°¡åŒ–ç›´æ¥é‡ç¹ªï¼Œæˆ–ä¹Ÿå¯åªæ›´æ–°è©²æ ¼
                    // ç‚ºäº†æ•ˆç‡ï¼Œå¯ä»¥åªæ›´æ–°è©²æ ¼:
                    let allTiles = document.querySelectorAll('.tile');
                    // å› ç‚º DOM é †åºèˆ‡é™£åˆ—ä¸€è‡´ (é™¤å»game-over div)
                    // ä½†æˆ‘å€‘æœ‰é‡æ–°ç”Ÿæˆæ©Ÿåˆ¶ï¼Œé€™è£¡ç°¡å–®é‡ç¹ªæœ€ç©©
                    renderBoard();
                    found = true;
                }
            }
        }

        function hasEmptyTile() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (board[r][c] == 0) return true;
                }
            }
            return false;
        }

        function checkGameOver() {
            if (hasEmptyTile()) return;
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (c < columns - 1 && board[r][c] == board[r][c+1]) return;
                    if (r < rows - 1 && board[r][c] == board[r+1][c]) return;
                }
            }
            
            isGameOver = true;
            document.getElementById("game-over").style.display = "flex";
            playSound('gameover');
        }

        // --- è¼¸å…¥ç›£è½ ---
        document.addEventListener('keyup', (e) => {
            if (e.code == "ArrowLeft") move('Left');
            else if (e.code == "ArrowRight") move('Right');
            else if (e.code == "ArrowUp") move('Up');
            else if (e.code == "ArrowDown") move('Down');
        });

        let startX, startY;
        const boardDom = document.getElementById('board');

        document.addEventListener('touchstart', (e) => {
            if(e.touches.length > 1) return;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if(!startX || !startY) return;
            let endX = e.changedTouches[0].clientX;
            let endY = e.changedTouches[0].clientY;
            let diffX = endX - startX;
            let diffY = endY - startY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (Math.abs(diffX) > 30) {
                    if (diffX > 0) move('Right'); else move('Left');
                }
            } else {
                if (Math.abs(diffY) > 30) {
                    if (diffY > 0) move('Down'); else move('Up');
                }
            }
            startX = null; startY = null;
        });
    </script>
</body>
</html>